---
import ReactPhoneInput from "./react-phone";
import { formatPhoneNumber } from "react-phone-number-input";
// Import LocationInfo type from the central definition
import type { LocationInfo } from "../utils/crypto";

const { clientID, pcId } = Astro.props;

// Remove the old LocationInfo type definition here

// Get location info from middleware
// const locationInfo = Astro.locals.locationInfo as LocationInfo | null;
const locationInfo = Astro.cookies.get("loc_info");
console.log("Location info from middleware:", locationInfo);

const search = Astro.url.pathname + Astro.url.search;
console.log(search);
const userIp = Astro.clientAddress; // Keep userIp if needed elsewhere, but not for fetch
console.log(userIp);

// REMOVED fetch to ip-api.com
---

<div id="container" class="bg-green">
  <script>
    //get _fbc cookie from browser
    const fbc = document.cookie
      .split("; ")
      .find((row) => row.startsWith("_fbc"))
      ?.split("=")[1];
    //get _fbp cookie from browser
    console.log(fbc);
    const fbp = document.cookie
      .split("; ")
      .find((row) => row.startsWith("_fbp"))
      ?.split("=")[1];
    console.log(fbp);
    //set _fbc cookie value to hidden input
    const fbcInput = document.querySelector('input[name="fbc"]');
    if (fbcInput) {
      fbcInput.setAttribute("value", fbc ?? "");
    }
    const fbpInput = document.querySelector('input[name="fbp"]');
    if (fbpInput) {
      fbpInput.setAttribute("value", fbp ?? "");
    }
  </script>
  <main>
    <div class="flex flex-col gap-2 items-center px-3 text-blue">
      <h1 class="text-2xl leading-6 text-blue">
        Preencha esse formulário e entre para o LactoFlow: {pcId}
      </h1>
      <form
        class="flex flex-col gap-1.5 w-full font-bold"
        method="post"
        action="/forms/leads-astro"
      >
        <label class="">
          Nome:
          <input type="text" placeholder="Nome" name="name" />
        </label>
        <label>
          Email:
          <input type="text" placeholder="maeincrivel@gmail.com" name="email" />
        </label>
        <label>
          Whatsapp:
          <ReactPhoneInput client:idle />
        </label>
        <input type="text" name="source" hidden value={search} />
        <input type="text" name="cta" hidden value="" />
        <input type="text" name="fbc" hidden />
        <input type="text" name="fbp" hidden />
        <input type="text" name="clientID" hidden value={clientID} />
        <input
          type="hidden"
          name="location"
          value={JSON.stringify(locationInfo?.value ?? {})}
        />
        <button
          class="mx-auto mt-4 w-full rounded-lg border-b-4 border-b-[#236C0F] bg-[#40C351] px-2 py-3 text-[13.6px] font-extrabold uppercase text-cream hover:scale-[104%] hover:border-b-[#44972d] hover:bg-[#236C0F] lg:py-5 lg:text-[22.6px]"
        >
          Quero entrar!
        </button>
        <h3 class="text-center text-base text-blue">
          SEUS DADOS ESTÃO SEGUROS
        </h3>
      </form>
    </div>
  </main>
</div>
